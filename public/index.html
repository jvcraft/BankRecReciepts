<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Reconciliation Wizard</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Serif:opsz,wght@8..144,300;8..144,400;8..144,500;8..144,600;8..144,700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="app">
        <!-- Navigation Bar -->
        <nav class="main-nav" id="mainNav" style="display: none;">
            <div class="nav-brand">Bank Reconciliation Wizard</div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-view="reconciliation">Home</button>
                <button class="nav-tab" data-view="history">History</button>
                <button class="nav-tab" data-view="settings">Settings</button>
            </div>
            <div class="nav-user" id="navUser">
                <span id="userEmail"></span>
                <button id="logoutBtn" class="secondary-btn">Logout</button>
            </div>
        </nav>

        <!-- Main Header (shown when not logged in or on reconciliation view) -->
        <header id="mainHeader">
            <h1>Reconciliation Wizard</h1>
            <p class="subtitle">Upload and compare bank statements with general ledger entries</p>
        </header>

        <!-- Reconciliation Section -->
        <main id="reconciliationView">
            <!-- File Upload Section -->
            <section class="upload-section">
                <div class="upload-card">
                    <h2>
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--primary-color)" stroke-width="2" style="vertical-align: -3px; margin-right: 0.5rem;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Upload Files
                    </h2>
                    <div class="file-inputs">
                        <div class="file-input-group">
                            <label for="bankFile">
                                <span class="label-title">Bank Statement</span>
                                <span class="label-desc">CSV, Excel, PDF, OFX, QFX, or QIF</span>
                            </label>
                            <input type="file" id="bankFile" accept=".csv,.xlsx,.xls,.pdf,.ofx,.qfx,.qif" />
                            <span class="file-name" id="bankFileName">No file selected</span>
                        </div>
                        <div class="file-input-group">
                            <label for="glFile">
                                <span class="label-title">General Ledger</span>
                                <span class="label-desc">CSV, Excel, or PDF</span>
                            </label>
                            <input type="file" id="glFile" accept=".xlsx,.xls,.csv,.pdf" />
                            <span class="file-name" id="glFileName">No file selected</span>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <h2>
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--primary-color)" stroke-width="2" style="vertical-align: -3px; margin-right: 0.5rem;">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        Matching Parameters
                    </h2>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="dateRange">Date Range (days)</label>
                            <input type="number" id="dateRange" value="3" min="0" max="30" />
                            <span class="setting-help">Allow matches within ± days</span>
                        </div>
                        <div class="setting-item">
                            <label for="amountTolerance">Amount Tolerance ($)</label>
                            <input type="number" id="amountTolerance" value="0.00" min="0" step="0.01" />
                            <span class="setting-help">Allow small differences</span>
                        </div>
                    </div>
                    <div id="statusIndicator" style="padding: 0.75rem; background: #fee2e2; border: 1px solid #dc2626; border-radius: 8px; margin-bottom: 0.75rem; display: none;">
                        <strong>Status:</strong> <span id="statusText">Waiting for files...</span>
                    </div>
                    <button id="reconcileBtn" class="primary-btn" disabled>
                        Start Reconciliation
                    </button>
                    <button id="debugBtn" class="secondary-btn" style="margin-top: 0.75rem; width: 100%;">
                        Check System Status
                    </button>
                </div>
            </section>

            <!-- Progress Section -->
            <section class="progress-section" id="progressSection" style="display: none;">
                <div class="progress-card">
                    <h3>Processing...</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="progressText">Analyzing files...</p>
                </div>
            </section>

            <!-- Results Section -->
            <section class="results-section" id="resultsSection" style="display: none;">
                <div class="summary-cards">
                    <div class="summary-card matched">
                        <div class="card-icon">✓</div>
                        <div class="card-content">
                            <h3 id="matchedCount">0</h3>
                            <p>Matched Transactions</p>
                        </div>
                    </div>
                    <div class="summary-card total">
                        <div class="card-icon">$</div>
                        <div class="card-content">
                            <h3 id="totalAmount">$0.00</h3>
                            <p>Total Matched</p>
                        </div>
                    </div>
                    <div class="summary-card unmatched-bank">
                        <div class="card-icon">!</div>
                        <div class="card-content">
                            <h3 id="unmatchedBankCount">0</h3>
                            <p>Unmatched Bank</p>
                        </div>
                    </div>
                    <div class="summary-card unmatched-gl">
                        <div class="card-icon">!</div>
                        <div class="card-content">
                            <h3 id="unmatchedGLCount">0</h3>
                            <p>Unmatched GL</p>
                        </div>
                    </div>
                    <div class="summary-card unmatched-total">
                        <div class="card-icon">⚠</div>
                        <div class="card-content">
                            <h3 id="unmatchedTotal">$0.00</h3>
                            <p>Unmatched Total</p>
                        </div>
                    </div>
                </div>

                <!-- Filter Section (temporarily hidden) -->
                <div class="filter-card" style="display: none;">
                    <h3>Filter Results</h3>
                    <div class="filter-grid">
                        <div class="filter-item">
                            <label for="dateFrom">Date From</label>
                            <input type="date" id="dateFrom" />
                        </div>
                        <div class="filter-item">
                            <label for="dateTo">Date To</label>
                            <input type="date" id="dateTo" />
                        </div>
                        <div class="filter-item">
                            <label for="amountMin">Amount Min ($)</label>
                            <input type="number" id="amountMin" step="0.01" />
                        </div>
                        <div class="filter-item">
                            <label for="amountMax">Amount Max ($)</label>
                            <input type="number" id="amountMax" step="0.01" />
                        </div>
                        <div class="filter-item filter-item-full">
                            <label for="searchText">Search (description, check #, account #)</label>
                            <input type="text" id="searchText" placeholder="Search..." />
                        </div>
                    </div>
                    <button id="clearFilters" class="secondary-btn clear-btn">Clear Filters</button>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" data-tab="matched">Matched Transactions</button>
                    <button class="tab-btn" data-tab="unmatched-bank">Unmatched Bank</button>
                    <button class="tab-btn" data-tab="unmatched-gl">Unmatched GL</button>
                </div>

                <div class="results-card">
                    <div class="results-header">
                        <h3 id="resultsTitle">Matched Transactions</h3>
                        <div class="export-buttons">
                            <button id="saveReconciliation" class="primary-btn" style="width: auto;">
                                Save
                            </button>
                            <button id="printReport" class="secondary-btn">
                                Print
                            </button>
                            <button id="exportExcel" class="secondary-btn">
                                Export to Excel
                            </button>
                            <button id="exportCSV" class="secondary-btn">
                                Export to CSV
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="resultsTable">
                            <thead id="resultsTableHead"></thead>
                            <tbody id="resultsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="resetBtn" class="secondary-btn">
                        Start New Reconciliation
                    </button>
                </div>
            </section>
        </main>

        <!-- History Section -->
        <section class="history-section" id="historyView" style="display: none;">
            <div class="history-header">
                <h2>Reconciliation History</h2>
                <div class="history-search">
                    <input type="text" id="historySearch" placeholder="Search reconciliations..." />
                    <select id="historyFilter">
                        <option value="all">All</option>
                        <option value="completed">Completed</option>
                        <option value="draft">Draft</option>
                    </select>
                </div>
            </div>
            <div class="history-list" id="historyList">
                <!-- History items will be populated dynamically -->
            </div>
            <div class="history-empty" id="historyEmpty" style="display: none;">
                <div class="history-empty-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </div>
                <h3>No Reconciliations Yet</h3>
                <p>Complete a reconciliation and save it to see your history here.</p>
                <p class="history-empty-hint">History will populate upon saving work.</p>
            </div>
            <div id="historyLoading" style="text-align: center; padding: 2rem; display: none;">
                <div class="spinner" style="margin: 0 auto;"></div>
                <p style="margin-top: 1rem; color: var(--text-secondary);">Loading history...</p>
            </div>
        </section>

        <!-- Settings Section -->
        <section class="settings-section" id="settingsView" style="display: none;">
            <h2>Settings</h2>

            <div class="settings-group">
                <h3>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 0.5rem;">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 0 1 0 4h-.09c-.658.003-1.25.396-1.51 1z"/>
                    </svg>
                    Default Matching Preferences
                </h3>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Default Date Range</h4>
                        <p>Days to allow for date matching</p>
                    </div>
                    <div class="settings-control">
                        <input type="number" id="settingsDateRange" value="3" min="0" max="30" />
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Default Amount Tolerance</h4>
                        <p>Dollar amount tolerance for matching</p>
                    </div>
                    <div class="settings-control">
                        <input type="number" id="settingsAmountTolerance" value="0.00" min="0" step="0.01" />
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Match by Check Number</h4>
                        <p>Prioritize check number matching when available</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsMatchByCheck" checked />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Match by Description</h4>
                        <p>Use description similarity as a matching factor</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsMatchByDescription" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Minimum Confidence Threshold</h4>
                        <p>Only show matches above this confidence level (%)</p>
                    </div>
                    <div class="settings-control">
                        <input type="number" id="settingsMinConfidence" value="50" min="0" max="100" step="5" />
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h3>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 0.5rem;">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    Data Parsing
                </h3>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Auto-detect Headers</h4>
                        <p>Automatically skip metadata rows and find column headers</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsAutoDetectHeaders" checked />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Handle Negative Amounts</h4>
                        <p>Treat negative debits/credits as absolute values</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsAbsoluteAmounts" checked />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Skip GL Expenditure Entries</h4>
                        <p>Exclude double-entry expenditure rows from GL data</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsSkipExpenditure" checked />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Date Parsing Preference</h4>
                        <p>How ambiguous dates (e.g., 01/02/2025) are interpreted</p>
                    </div>
                    <div class="settings-control">
                        <select id="settingsDateParsing">
                            <option value="MDY">Month/Day/Year (US)</option>
                            <option value="DMY">Day/Month/Year (EU)</option>
                            <option value="YMD">Year/Month/Day (ISO)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h3>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 0.5rem;">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                        <line x1="8" y1="21" x2="16" y2="21"/>
                        <line x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                    Display Preferences
                </h3>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Date Format</h4>
                        <p>How dates are displayed in results</p>
                    </div>
                    <div class="settings-control">
                        <select id="settingsDateFormat">
                            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                            <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                        </select>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Currency Format</h4>
                        <p>Currency symbol and formatting</p>
                    </div>
                    <div class="settings-control">
                        <select id="settingsCurrencyFormat">
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (&euro;)</option>
                            <option value="GBP">GBP (&pound;)</option>
                            <option value="CAD">CAD (C$)</option>
                        </select>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Theme</h4>
                        <p>Application color theme</p>
                    </div>
                    <div class="settings-control">
                        <select id="settingsTheme">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="system">System Default</option>
                        </select>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Results Per Page</h4>
                        <p>Maximum rows shown in results table</p>
                    </div>
                    <div class="settings-control">
                        <select id="settingsResultsPerPage">
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="250">250</option>
                            <option value="500">500</option>
                            <option value="0">Show All</option>
                        </select>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Show Confidence Scores</h4>
                        <p>Display match confidence percentages in results</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsShowConfidence" checked />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Highlight Close Matches</h4>
                        <p>Visually highlight matches that are close but not exact</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsHighlightClose" checked />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h3>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 0.5rem;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export &amp; Save
                </h3>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Default Export Format</h4>
                        <p>Preferred format for exports</p>
                    </div>
                    <div class="settings-control">
                        <select id="settingsExportFormat">
                            <option value="xlsx">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                        </select>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Include Unmatched in Export</h4>
                        <p>Export unmatched items alongside matched transactions</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsExportUnmatched" checked />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <h4>Auto-save Reconciliations</h4>
                        <p>Automatically save after completing reconciliation</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsAutoSave" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="settings-actions">
                <button id="saveSettings" class="primary-btn" style="width: auto; padding: 0.75rem 2rem;">
                    Save Settings
                </button>
                <button id="resetSettings" class="secondary-btn" style="padding: 0.75rem 1.5rem;">
                    Reset to Defaults
                </button>
            </div>
        </section>
    </div>

    <!-- Manual Match Modal -->
    <div id="manualMatchModal" class="modal" style="display: none;">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2 id="manualMatchTitle">Select Match</h2>
                <button class="modal-close" id="manualMatchCloseBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="manualMatchSourceInfo" class="source-info-container"></div>
                <div class="divider"></div>

                <!-- Tab switcher for existing vs custom match -->
                <div class="match-tabs">
                    <button class="match-tab-btn active" data-tab="existing">Select Existing</button>
                    <button class="match-tab-btn" data-tab="custom">Create Custom Entry</button>
                </div>

                <!-- Existing matches tab -->
                <div id="existingMatchTab" class="match-tab-content">
                    <p class="modal-description">Select one or more items to match (useful when transactions are split into multiple entries):</p>

                    <!-- Selection Summary -->
                    <div id="selectionSummary" class="selection-summary" style="display: none;">
                        <div class="selection-summary-header">
                            <span class="selection-count"><span id="selectedCount">0</span> item(s) selected</span>
                            <button type="button" class="clear-selection-btn" id="clearSelectionBtn">Clear All</button>
                        </div>
                        <div class="selection-totals">
                            <div class="selection-total-item">
                                <span class="label">Selected Total:</span>
                                <span class="value" id="selectedTotal">$0.00</span>
                            </div>
                            <div class="selection-total-item">
                                <span class="label">Target Amount:</span>
                                <span class="value" id="targetAmount">$0.00</span>
                            </div>
                            <div class="selection-total-item difference">
                                <span class="label">Difference:</span>
                                <span class="value" id="selectionDifference">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <div id="matchCandidatesList" class="match-candidates-list"></div>
                </div>

                <!-- Custom entry tab -->
                <div id="customMatchTab" class="match-tab-content" style="display: none;">
                    <p class="modal-description">Enter details for a custom match entry:</p>
                    <div class="custom-match-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customDate">Date</label>
                                <input type="date" id="customDate" />
                            </div>
                            <div class="form-group">
                                <label for="customAmount">Amount</label>
                                <input type="number" id="customAmount" step="0.01" placeholder="0.00" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customAccountNumber">Account Number / Check #</label>
                                <input type="text" id="customAccountNumber" placeholder="e.g., 19001 or 5-01-101-01-100-001" />
                            </div>
                            <div class="form-group">
                                <label for="customType">Transaction Type</label>
                                <select id="customType">
                                    <option value="manual">Manual Entry</option>
                                    <option value="check">Check</option>
                                    <option value="deposit">Deposit</option>
                                    <option value="transfer">Transfer</option>
                                    <option value="adjustment">Adjustment</option>
                                    <option value="fee">Fee/Charge</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="customDescription">Description</label>
                            <input type="text" id="customDescription" placeholder="Enter transaction description" />
                        </div>
                        <div class="form-group">
                            <label for="customNotes">Notes (optional)</label>
                            <textarea id="customNotes" rows="2" placeholder="Additional notes about this match..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary-btn" id="manualMatchCancelBtn">Cancel</button>
                <button class="primary-btn" id="manualMatchConfirmBtn">Confirm Match</button>
            </div>
        </div>
    </div>

    <!-- Debug/Error Modal -->
    <div id="debugModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="debugModalTitle">System Status</h2>
                <button class="modal-close" id="debugModalCloseBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="debugModalContent"></div>
            </div>
            <div class="modal-footer">
                <button class="primary-btn" id="debugModalOkBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Save Reconciliation Modal -->
    <div id="saveModal" class="modal" style="display: none;">
        <div class="modal-content save-modal-content">
            <div class="modal-header">
                <h2>Save Reconciliation</h2>
                <button class="modal-close" id="saveModalCloseBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="save-form">
                    <div class="form-group">
                        <label for="saveName">Name</label>
                        <input type="text" id="saveName" placeholder="e.g., January 2026 Reconciliation" />
                    </div>
                    <div class="form-group">
                        <label for="saveDescription">Description (optional)</label>
                        <textarea id="saveDescription" placeholder="Add notes about this reconciliation..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary-btn" id="saveModalCancelBtn">Cancel</button>
                <button class="primary-btn" id="confirmSaveBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>

    <!-- Application Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script src="js/history.js"></script>
    <script src="js/settings.js"></script>

    <script>
        // Wait for DOM to be ready before attaching event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation handling
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const view = tab.dataset.view;
                    switchView(view);
                });
            });

            // Initialize save button
            const saveRecBtn = document.getElementById('saveReconciliation');
            if (saveRecBtn) {
                saveRecBtn.addEventListener('click', openSaveModal);
            }

            // Debug Modal buttons
            const debugModalCloseBtn = document.getElementById('debugModalCloseBtn');
            const debugModalOkBtn = document.getElementById('debugModalOkBtn');
            if (debugModalCloseBtn) {
                debugModalCloseBtn.addEventListener('click', closeDebugModal);
            }
            if (debugModalOkBtn) {
                debugModalOkBtn.addEventListener('click', closeDebugModal);
            }

            // Manual Match Modal buttons
            const manualMatchCloseBtn = document.getElementById('manualMatchCloseBtn');
            const manualMatchCancelBtn = document.getElementById('manualMatchCancelBtn');
            const manualMatchConfirmBtn = document.getElementById('manualMatchConfirmBtn');
            if (manualMatchCloseBtn) {
                manualMatchCloseBtn.addEventListener('click', closeManualMatchModal);
            }
            if (manualMatchCancelBtn) {
                manualMatchCancelBtn.addEventListener('click', closeManualMatchModal);
            }
            if (manualMatchConfirmBtn) {
                manualMatchConfirmBtn.addEventListener('click', confirmManualMatch);
            }

            // Match Modal Tab switching
            document.querySelectorAll('.match-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    switchMatchTab(tab);
                });
            });

            // Save Modal buttons
            const saveModalCloseBtn = document.getElementById('saveModalCloseBtn');
            const saveModalCancelBtn = document.getElementById('saveModalCancelBtn');
            const confirmSaveBtn = document.getElementById('confirmSaveBtn');
            if (saveModalCloseBtn) {
                saveModalCloseBtn.addEventListener('click', closeSaveModal);
            }
            if (saveModalCancelBtn) {
                saveModalCancelBtn.addEventListener('click', closeSaveModal);
            }
            if (confirmSaveBtn) {
                confirmSaveBtn.addEventListener('click', confirmSave);
            }

            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });

            // Close modals with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            });
        });

        function switchView(view) {
            // Update tabs
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.nav-tab[data-view="${view}"]`).classList.add('active');

            // Update views
            document.getElementById('reconciliationView').style.display = view === 'reconciliation' ? 'block' : 'none';
            document.getElementById('historyView').style.display = view === 'history' ? 'block' : 'none';
            document.getElementById('settingsView').style.display = view === 'settings' ? 'block' : 'none';
            document.getElementById('mainHeader').style.display = view === 'reconciliation' ? 'block' : 'none';

            // Load data for the view
            if (view === 'history' && typeof loadHistory === 'function') {
                loadHistory();
            }
            if (view === 'settings' && typeof loadSettings === 'function') {
                loadSettings();
            }
        }

        // Save modal functions
        function openSaveModal() {
            document.getElementById('saveModal').style.display = 'flex';
            document.getElementById('saveName').value = `Reconciliation ${new Date().toLocaleDateString()}`;
            document.getElementById('saveDescription').value = '';
        }

        function closeSaveModal() {
            document.getElementById('saveModal').style.display = 'none';
        }

        async function confirmSave() {
            const name = document.getElementById('saveName').value.trim();
            const description = document.getElementById('saveDescription').value.trim();

            if (!name) {
                alert('Please enter a name for this reconciliation.');
                return;
            }

            const saveBtn = document.getElementById('confirmSaveBtn');
            saveBtn.classList.add('btn-loading');
            saveBtn.disabled = true;

            try {
                const result = await saveReconciliation(name, description);
                closeSaveModal();

                // Refresh history data in background so it's ready when user views it
                if (typeof loadHistory === 'function') {
                    loadHistory(true);
                }

                // Show success message with option to view history
                const viewHistory = confirm('Reconciliation saved successfully!\n\nWould you like to view it in History?');
                if (viewHistory) {
                    switchView('history');
                }
            } catch (error) {
                alert('Failed to save: ' + error.message);
            } finally {
                saveBtn.classList.remove('btn-loading');
                saveBtn.disabled = false;
            }
        }

        // Global modal helper functions
        function closeDebugModal() {
            document.getElementById('debugModal').style.display = 'none';
        }

        function closeManualMatchModal() {
            document.getElementById('manualMatchModal').style.display = 'none';
            // Reset to existing tab when closing
            switchMatchTab('existing');
            // Clear custom form
            clearCustomMatchForm();
        }

        function confirmManualMatch() {
            // Check which tab is active
            const customTab = document.getElementById('customMatchTab');
            const isCustomMode = customTab && customTab.style.display !== 'none';

            if (isCustomMode) {
                // Handle custom match creation
                confirmCustomMatch();
            } else {
                // Handle existing match selection
                if (typeof app !== 'undefined' && app && typeof app.confirmManualMatch === 'function') {
                    app.confirmManualMatch();
                }
            }
        }

        function switchMatchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.match-tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            // Show/hide content
            document.getElementById('existingMatchTab').style.display = tab === 'existing' ? 'block' : 'none';
            document.getElementById('customMatchTab').style.display = tab === 'custom' ? 'block' : 'none';

            // Update confirm button text
            const confirmBtn = document.getElementById('manualMatchConfirmBtn');
            if (confirmBtn) {
                confirmBtn.textContent = tab === 'custom' ? 'Create Custom Match' : 'Confirm Match';
            }
        }

        function clearCustomMatchForm() {
            document.getElementById('customDate').value = '';
            document.getElementById('customAmount').value = '';
            document.getElementById('customAccountNumber').value = '';
            document.getElementById('customType').value = 'manual';
            document.getElementById('customDescription').value = '';
            document.getElementById('customNotes').value = '';
        }

        function confirmCustomMatch() {
            const date = document.getElementById('customDate').value;
            const amount = parseFloat(document.getElementById('customAmount').value);
            const accountNumber = document.getElementById('customAccountNumber').value.trim();
            const type = document.getElementById('customType').value;
            const description = document.getElementById('customDescription').value.trim();
            const notes = document.getElementById('customNotes').value.trim();

            // Validation
            if (!amount || isNaN(amount)) {
                alert('Please enter a valid amount.');
                return;
            }

            if (!description) {
                alert('Please enter a description.');
                return;
            }

            // Create custom entry and match it
            if (typeof app !== 'undefined' && app && typeof app.createCustomMatch === 'function') {
                app.createCustomMatch({
                    date: date ? new Date(date) : new Date(),
                    amount: amount,
                    accountNumber: accountNumber,
                    type: type,
                    description: description,
                    notes: notes
                });
            }

            closeManualMatchModal();
        }

        // Smooth scroll handling for navigation
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            const nav = document.getElementById('mainNav');
            if (nav) {
                if (window.scrollY > 10) {
                    nav.classList.add('scrolled');
                } else {
                    nav.classList.remove('scrolled');
                }
            }
        }, { passive: true });
    </script>
</body>
</html>
